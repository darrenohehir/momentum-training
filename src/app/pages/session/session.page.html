<ion-header>
  <ion-toolbar>
    <ion-title>Session In Progress</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  <ng-container *ngIf="isLoading">
    <div class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading session...</p>
    </div>
  </ng-container>

  <!-- Error State -->
  <ng-container *ngIf="!isLoading && loadError">
    <div class="error-state">
      <ion-icon name="alert-circle-outline"></ion-icon>
      <h2>Session not found</h2>
      <p>Unable to load this session.</p>
      <ion-button routerLink="/tabs/home" fill="outline">
        Return Home
      </ion-button>
    </div>
  </ng-container>

  <!-- Session Info -->
  <ng-container *ngIf="!isLoading && !loadError && session">
    <ion-card class="session-info-card">
      <ion-card-header>
        <ion-card-subtitle>
          {{ formatStartDate(session.startedAt) }}
        </ion-card-subtitle>
        <ion-card-title>
          Started at {{ formatStartTime(session.startedAt) }}
        </ion-card-title>
      </ion-card-header>
      <ion-card-content *ngIf="getQuestLabel(session.questId) as questLabel">
        <ion-chip>
          <ion-icon name="fitness-outline"></ion-icon>
          <ion-label>{{ questLabel }}</ion-label>
        </ion-chip>
      </ion-card-content>
    </ion-card>

    <!-- Exercises Section -->
    <div class="exercises-section">
      <div class="section-header">
        <h2>Exercises</h2>
        <span class="exercise-count" *ngIf="sessionExercises.length > 0">
          {{ sessionExercises.length }}
        </span>
      </div>

      <!-- Loading exercises -->
      <div *ngIf="isLoadingExercises" class="ion-padding-vertical">
        <ion-card *ngFor="let i of [1,2]">
          <ion-card-header>
            <ion-card-title><ion-skeleton-text animated style="width: 60%"></ion-skeleton-text></ion-card-title>
            <ion-card-subtitle><ion-skeleton-text animated style="width: 40%"></ion-skeleton-text></ion-card-subtitle>
          </ion-card-header>
        </ion-card>
      </div>

      <!-- Exercise Cards with Sets (Reorderable) -->
      <ion-reorder-group
        *ngIf="!isLoadingExercises && sessionExercises.length > 0"
        [disabled]="false"
        (ionItemReorder)="handleExerciseReorder($event)"
        class="exercise-cards"
      >
        <ion-item *ngFor="let item of sessionExercises; let exIndex = index" lines="none" class="exercise-item">
          <ion-reorder slot="start"></ion-reorder>
          <ion-card class="exercise-card">
            <!-- Exercise Header -->
            <ion-card-header>
              <div class="exercise-header-row">
                <div class="exercise-header-info">
                  <ion-card-subtitle>
                    <span class="exercise-number">{{ exIndex + 1 }}</span>
                    {{ formatCategory(item.exercise.category) }}
                  </ion-card-subtitle>
                  <ion-card-title>{{ item.exercise.name }}</ion-card-title>
                </div>
                <ion-button
                  fill="clear"
                  size="small"
                  color="medium"
                  class="remove-exercise-button"
                  (click)="removeExercise(item)"
                >
                  <ion-icon slot="icon-only" name="close-outline"></ion-icon>
                </ion-button>
              </div>
            </ion-card-header>

          <ion-card-content>
            <!-- Ghost Mode: Previous attempt (if exists) -->
            <ng-container *ngIf="getGhost(item.exercise.id) as ghost">
              <div class="ghost-section" *ngIf="ghost.sets.length > 0">
                <div class="ghost-header">
                  <span class="ghost-label">Previous</span>
                  <span class="ghost-date">{{ formatGhostDate(ghost.session.endedAt!) }}</span>
                </div>
                <div class="ghost-sets">
                  <span class="ghost-set" *ngFor="let set of ghost.sets">
                    {{ formatGhostSet(set) }}
                  </span>
                </div>
                <!-- Copy last sets button (only when no sets logged yet) -->
                <ion-button
                  *ngIf="canCopyLastSets(item)"
                  fill="clear"
                  size="small"
                  class="copy-sets-button"
                  (click)="copyLastSets(item)"
                >
                  <ion-icon slot="start" name="copy-outline"></ion-icon>
                  Copy last sets
                </ion-button>
              </div>
            </ng-container>

            <!-- RPE Toggle (strength only) -->
            <div class="rpe-toggle" *ngIf="getSetLogType(item) === 'strength'">
              <ion-button
                fill="clear"
                size="small"
                (click)="toggleRpe(item)"
                [color]="item.showRpe ? 'primary' : 'medium'"
              >
                <ion-icon slot="start" name="speedometer-outline"></ion-icon>
                {{ item.showRpe ? 'Hide RPE' : 'Show RPE' }}
              </ion-button>
            </div>

            <!-- Strength: Sets Header -->
            <div class="sets-header" *ngIf="getSetLogType(item) === 'strength' && item.sets.length > 0">
              <span class="set-col set-label">Set</span>
              <span class="set-col weight-label">Weight (kg)</span>
              <span class="set-col reps-label">Reps</span>
              <span class="set-col rpe-label" *ngIf="item.showRpe">RPE</span>
              <span class="set-col action-label"></span>
            </div>

            <!-- Cardio: Sets Header -->
            <div class="sets-header sets-header--cardio" *ngIf="getSetLogType(item) !== 'strength' && item.sets.length > 0">
              <span class="set-col set-label">Set</span>
              <span class="set-col duration-label">Duration</span>
              <span class="set-col distance-label">Distance</span>
              <span class="set-col incline-label">Incline</span>
              <span class="set-col action-label"></span>
            </div>

            <!-- Sets Loading -->
            <div *ngIf="item.isLoadingSets" class="sets-loading">
              <ion-skeleton-text animated style="width: 100%; height: 40px;"></ion-skeleton-text>
            </div>

            <!-- Strength Sets List -->
            <div class="sets-list" *ngIf="!item.isLoadingSets && getSetLogType(item) === 'strength'">
              <div class="set-row" *ngFor="let set of item.sets; let setIdx = index">
                <span class="set-col set-number">{{ set.setIndex + 1 }}</span>
                <div class="set-col weight-input">
                  <ion-input
                    type="text"
                    inputmode="decimal"
                    autocomplete="off"
                    enterkeyhint="next"
                    placeholder="—"
                    [value]="set.weight"
                    (ionInput)="onWeightChange(set, $any($event).target.value)"
                    (ionBlur)="onInputBlur(set)"
                  ></ion-input>
                </div>
                <div class="set-col reps-input">
                  <ion-input
                    type="text"
                    inputmode="numeric"
                    autocomplete="off"
                    enterkeyhint="next"
                    placeholder="—"
                    [value]="set.reps"
                    (ionInput)="onRepsChange(set, $any($event).target.value)"
                    (ionBlur)="onInputBlur(set)"
                  ></ion-input>
                </div>
                <div class="set-col rpe-input" *ngIf="item.showRpe">
                  <ion-input
                    type="text"
                    inputmode="numeric"
                    autocomplete="off"
                    enterkeyhint="done"
                    placeholder="—"
                    [value]="set.rpe"
                    (ionInput)="onRpeChange(set, $any($event).target.value)"
                    (ionBlur)="onInputBlur(set)"
                  ></ion-input>
                </div>
                <div class="set-col action-col">
                  <ion-button
                    fill="clear"
                    size="small"
                    color="danger"
                    (click)="removeSet(item, set)"
                  >
                    <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                  </ion-button>
                </div>
              </div>
              <div *ngIf="item.sets.length === 0" class="no-sets">
                <p>No sets logged yet</p>
              </div>
            </div>

            <!-- Cardio Sets List -->
            <div class="sets-list sets-list--cardio" *ngIf="!item.isLoadingSets && getSetLogType(item) !== 'strength'">
              <div class="set-row set-row--cardio" *ngFor="let set of item.sets; let setIdx = index">
                <span class="set-col set-number">{{ set.setIndex + 1 }}</span>
                <div class="set-col duration-inputs">
                  <ion-input
                    type="number"
                    inputmode="numeric"
                    min="0"
                    placeholder="0"
                    [value]="durationMinutes(set)"
                    (ionInput)="onDurationMinChange(set, $any($event).target.value)"
                    (ionBlur)="onInputBlur(set)"
                  ></ion-input>
                  <span class="duration-sep">:</span>
                  <ion-input
                    type="number"
                    inputmode="numeric"
                    min="0"
                    max="59"
                    placeholder="00"
                    [value]="durationSeconds(set)"
                    (ionInput)="onDurationSecChange(set, $any($event).target.value)"
                    (ionBlur)="onInputBlur(set)"
                  ></ion-input>
                </div>
                <div class="set-col distance-input">
                  <ion-input
                    type="text"
                    inputmode="decimal"
                    placeholder="—"
                    [value]="getDistanceKmForDisplay(set)"
                    (ionInput)="onDistanceChange(set, $any($event).target.value)"
                    (ionBlur)="onInputBlur(set)"
                  ></ion-input>
                </div>
                <div class="set-col incline-input">
                  <ion-input
                    type="text"
                    inputmode="decimal"
                    placeholder="%"
                    [value]="set.incline"
                    (ionInput)="onInclineChange(set, $any($event).target.value)"
                    (ionBlur)="onInputBlur(set)"
                  ></ion-input>
                </div>
                <div class="set-col action-col">
                  <ion-button
                    fill="clear"
                    size="small"
                    color="danger"
                    (click)="removeSet(item, set)"
                  >
                    <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                  </ion-button>
                </div>
              </div>
              <div *ngIf="item.sets.length === 0" class="no-sets">
                <p>No sets logged yet</p>
              </div>
            </div>

            <!-- Add Set Button -->
            <ion-button
              expand="block"
              fill="clear"
              size="small"
              class="add-set-button"
              (click)="addSet(item)"
            >
              <ion-icon slot="start" name="add-outline"></ion-icon>
              Add Set
            </ion-button>
          </ion-card-content>
          </ion-card>
        </ion-item>
      </ion-reorder-group>

      <!-- Empty State -->
      <div *ngIf="!isLoadingExercises && sessionExercises.length === 0" class="exercises-empty">
        <ion-icon name="barbell-outline"></ion-icon>
        <p>No exercises added yet</p>
      </div>

      <!-- Add Exercise Button -->
      <ion-button
        expand="block"
        fill="outline"
        class="add-exercise-button"
        (click)="openExercisePicker()"
      >
        <ion-icon slot="start" name="add-outline"></ion-icon>
        Add Exercise
      </ion-button>
    </div>

    <!-- Finish Session Button -->
    <p class="finish-session-hint" *ngIf="!canFinishSession() && sessionExercises.length > 0">
      Complete all sets: reps for strength, duration for cardio.
    </p>
    <ion-button
      expand="block"
      class="finish-session-button"
      (click)="finishSession()"
      [disabled]="isFinishing || !canFinishSession()"
    >
      <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
      {{ isFinishing ? 'Finishing...' : 'Finish Session' }}
    </ion-button>
  </ng-container>
</ion-content>
