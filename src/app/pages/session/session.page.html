<ion-header>
  <ion-toolbar>
    <ion-title>Session In Progress</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  <ng-container *ngIf="isLoading">
    <div class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading session...</p>
    </div>
  </ng-container>

  <!-- Error State -->
  <ng-container *ngIf="!isLoading && loadError">
    <div class="error-state">
      <ion-icon name="alert-circle-outline"></ion-icon>
      <h2>Session not found</h2>
      <p>Unable to load this session.</p>
      <ion-button routerLink="/tabs/home" fill="outline">
        Return Home
      </ion-button>
    </div>
  </ng-container>

  <!-- Session Info -->
  <ng-container *ngIf="!isLoading && !loadError && session">
    <ion-card class="session-info-card">
      <ion-card-header>
        <ion-card-subtitle>
          {{ formatStartDate(session.startedAt) }}
        </ion-card-subtitle>
        <ion-card-title>
          Started at {{ formatStartTime(session.startedAt) }}
        </ion-card-title>
      </ion-card-header>
      <ion-card-content *ngIf="getQuestLabel(session.questId) as questLabel">
        <ion-chip>
          <ion-icon name="fitness-outline"></ion-icon>
          <ion-label>{{ questLabel }}</ion-label>
        </ion-chip>
      </ion-card-content>
    </ion-card>

    <!-- Exercises Section -->
    <div class="exercises-section">
      <div class="section-header">
        <h2>Exercises</h2>
        <span class="exercise-count" *ngIf="sessionExercises.length > 0">
          {{ sessionExercises.length }}
        </span>
      </div>

      <!-- Loading exercises -->
      <div *ngIf="isLoadingExercises" class="ion-padding-vertical">
        <ion-card *ngFor="let i of [1,2]">
          <ion-card-header>
            <ion-card-title><ion-skeleton-text animated style="width: 60%"></ion-skeleton-text></ion-card-title>
            <ion-card-subtitle><ion-skeleton-text animated style="width: 40%"></ion-skeleton-text></ion-card-subtitle>
          </ion-card-header>
        </ion-card>
      </div>

      <!-- Exercise Cards with Sets -->
      <div *ngIf="!isLoadingExercises && sessionExercises.length > 0" class="exercise-cards">
        <ion-card *ngFor="let item of sessionExercises; let exIndex = index" class="exercise-card">
          <!-- Exercise Header -->
          <ion-card-header>
            <ion-card-subtitle>
              <span class="exercise-number">{{ exIndex + 1 }}</span>
              {{ formatCategory(item.exercise.category) }}
            </ion-card-subtitle>
            <ion-card-title>{{ item.exercise.name }}</ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <!-- Ghost Mode: Previous attempt (if exists) -->
            <ng-container *ngIf="getGhost(item.exercise.id) as ghost">
              <div class="ghost-section" *ngIf="ghost.sets.length > 0">
                <div class="ghost-header">
                  <span class="ghost-label">Previous</span>
                  <span class="ghost-date">{{ formatGhostDate(ghost.session.endedAt!) }}</span>
                </div>
                <div class="ghost-sets">
                  <span class="ghost-set" *ngFor="let set of ghost.sets">
                    {{ formatGhostSet(set) }}
                  </span>
                </div>
              </div>
            </ng-container>

            <!-- RPE Toggle -->
            <div class="rpe-toggle">
              <ion-button
                fill="clear"
                size="small"
                (click)="toggleRpe(item)"
                [color]="item.showRpe ? 'primary' : 'medium'"
              >
                <ion-icon slot="start" name="speedometer-outline"></ion-icon>
                {{ item.showRpe ? 'Hide RPE' : 'Show RPE' }}
              </ion-button>
            </div>

            <!-- Sets Header -->
            <div class="sets-header" *ngIf="item.sets.length > 0">
              <span class="set-col set-label">Set</span>
              <span class="set-col weight-label">Weight (kg)</span>
              <span class="set-col reps-label">Reps</span>
              <span class="set-col rpe-label" *ngIf="item.showRpe">RPE</span>
              <span class="set-col action-label"></span>
            </div>

            <!-- Sets Loading -->
            <div *ngIf="item.isLoadingSets" class="sets-loading">
              <ion-skeleton-text animated style="width: 100%; height: 40px;"></ion-skeleton-text>
            </div>

            <!-- Sets List -->
            <div class="sets-list" *ngIf="!item.isLoadingSets">
              <div class="set-row" *ngFor="let set of item.sets">
                <span class="set-col set-number">{{ set.setIndex + 1 }}</span>
                <div class="set-col weight-input">
                  <ion-input
                    type="number"
                    inputmode="decimal"
                    placeholder="—"
                    [value]="set.weight"
                    (ionInput)="onWeightChange(set, $any($event).target.value)"
                    (ionBlur)="onInputBlur(set)"
                  ></ion-input>
                </div>
                <div class="set-col reps-input">
                  <ion-input
                    type="number"
                    inputmode="numeric"
                    placeholder="—"
                    [value]="set.reps"
                    (ionInput)="onRepsChange(set, $any($event).target.value)"
                    (ionBlur)="onInputBlur(set)"
                  ></ion-input>
                </div>
                <div class="set-col rpe-input" *ngIf="item.showRpe">
                  <ion-input
                    type="number"
                    inputmode="numeric"
                    placeholder="—"
                    min="1"
                    max="10"
                    [value]="set.rpe"
                    (ionInput)="onRpeChange(set, $any($event).target.value)"
                    (ionBlur)="onInputBlur(set)"
                  ></ion-input>
                </div>
                <div class="set-col action-col">
                  <ion-button
                    fill="clear"
                    size="small"
                    color="danger"
                    (click)="removeSet(item, set)"
                  >
                    <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                  </ion-button>
                </div>
              </div>

              <!-- Empty Sets State -->
              <div *ngIf="item.sets.length === 0" class="no-sets">
                <p>No sets logged yet</p>
              </div>
            </div>

            <!-- Add Set Button -->
            <ion-button
              expand="block"
              fill="clear"
              size="small"
              class="add-set-button"
              (click)="addSet(item)"
            >
              <ion-icon slot="start" name="add-outline"></ion-icon>
              Add Set
            </ion-button>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoadingExercises && sessionExercises.length === 0" class="exercises-empty">
        <ion-icon name="barbell-outline"></ion-icon>
        <p>No exercises added yet</p>
      </div>

      <!-- Add Exercise Button -->
      <ion-button
        expand="block"
        fill="outline"
        class="add-exercise-button"
        (click)="openExercisePicker()"
      >
        <ion-icon slot="start" name="add-outline"></ion-icon>
        Add Exercise
      </ion-button>
    </div>

    <!-- Finish Session Button -->
    <ion-button
      expand="block"
      class="finish-session-button"
      (click)="finishSession()"
      [disabled]="isFinishing"
    >
      <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
      {{ isFinishing ? 'Finishing...' : 'Finish Session' }}
    </ion-button>
  </ng-container>
</ion-content>
